<template>
  <div class="login-view is-flex">
    <html-header :title="$gettext('Login')"/>
    <base-form
      v-show="mode=='signin'"
      :promise="promise"
      @submit="signin">

      <form-field
        name="username"
        v-model="username"
        required
        type="text"
        :label="$gettext('Username')"
        icon="user"/>

      <form-field
        :name="password"
        v-model="password"
        required
        type="password"
        :label="$gettext('Password')"
        icon="key"/>

      <div class="buttons is-centered">
        <button type="submit" class="button is-primary" :class="{'is-loading':promise.loading}" v-translate>
          Login
        </button>
        <button type="button" class="button is-warning" @click="setMode('resetPassword')" v-translate>
          Forgot password?
        </button>
        <button type="button" class="button is-link" @click="setMode('signup')" v-translate>
          No account yet?
        </button>
      </div>
    </base-form>

    <base-form
      v-show="mode=='signup'"
      :promise="promise"
      @submit="signup">

      <form-field
        name="name"
        v-model="name"
        type="text"
        :label="$gettext('Fullname')"
        icon="user-check"/>
      <form-field
        name="username"
        v-model="username"
        type="text"
        :label="$gettext('Username')"
        icon="user"/>
      <form-field
        name="forum_username"
        v-model="forum_username"
        type="text"
        :label="$gettext('Forum username')"
        icon="comments"/>
      <form-field
        name="password"
        v-model="password"
        type="password"
        :label="$gettext('Password')"
        icon="key"/>
      <form-field
        name="email"
        v-model="email"
        type="email"
        :label="$gettext('Email')"
        icon="at"/>
      <div class="field">
        <div class="control">
          <label class="checkbox">
            <input type="checkbox" v-model="termsAgreed">
            &nbsp;
            <span v-translate>
              I have read and agree to the terms of use
            </span>
            <span> (</span>
            <router-link :to="{name:'article', params:{id:106731}}" v-translate>
              link
            </router-link>
            <span>).</span>
          </label>
        </div>
      </div>

      <div class="field">
        <vue-recaptcha
          ref="recaptcha"
          :sitekey="$options.recaptchaKey"
          @expired="onCaptchaExpired"
          @verify="onCaptchaVerify"/>
      </div>

      <div class="buttons is-centered">
        <button
          type="submit"
          class="button is-primary"
          :class="{'is-loading':promise.loading}"
          :disabled="!termsAgreed || !captcha"
          v-translate>
          Register
        </button>
        <button type="button" class="button is-link" @click="setMode('signin')" v-translate>
          Have an account?
        </button>
      </div>
    </base-form>

    <base-form
      ref="resetPasswordForm"
      v-show="mode=='resetPassword'"
      :promise="promise"
      @submit="resetPassword">

      <h3 slot="header" class="title is-3" v-translate>
        Reset password
      </h3>

      <form-field
        name="email"
        v-model="email"
        type="email"
        :label="$gettext('Email')"
        icon="at"/>

      <div class="buttons is-centered">
        <button type="submit" class="button is-link" :class="{'is-loading':promise.loading}" v-translate>
          Send reset email
        </button>
        <button type="button" class="button is-link" @click="setMode('signin')" v-translate>
          Login
        </button>
      </div>

      <div v-if="promise.success" class="notification is-info" v-translate>
        We sent you an email, please click on the link to reset password.
      </div>
    </base-form>

    <base-form
      ref="changePasswordForm"
      v-show="mode=='changePassword'"
      :promise="promise"
      @submit="validateNewPassword">

      <h3 slot="header" class="title is-3" v-translate>
        Change password
      </h3>

      <form-field
        name="password"
        v-model="password"
        type="password"
        :label="$gettext('New password')"
        icon="key"/>

      <div class="buttons is-centered">
        <button type="submit" class="button is-link" :class="{'is-loading':promise.loading}" v-translate>
          Change password
        </button>
        <button type="button" class="button is-link" @click="setMode('signin')" v-translate>
          Cancel
        </button>
      </div>

    </base-form>

    <base-form
      v-show="mode=='changeEmail' || mode=='validateAccountCreation'"
      :promise="promise">
      <div v-if="promise.loading" v-translate>
        Checking...
      </div>
    </base-form>

  </div>
</template>

<script>
  import c2c from '@/js/apis/c2c';
  import config from '@/js/config';

  import FormField from './utils/FormField';
  import BaseForm from './utils/BaseForm';

  import VueRecaptcha from 'vue-recaptcha';

  // possible mode values :
  //
  // * sigin, default : sign in with your account
  // * signup : create account
  // * resetPassword : get a mail with an secret URL to reset your password
  // * changePassword : with url from precedent mode, set a new password
  // * changeEmail : if user has asked a new mail, a secret url has been sent
  // * validateAccountCreation : idem, but when account is created

  export default {

    recaptchaKey: config.urls.recaptchaKey,

    components: {
      FormField,
      BaseForm,
      VueRecaptcha
    },

    data() {
      return {
        mode: 'signin',

        username: '',
        password: '',
        name: '',
        forum_username: '',
        email: '',
        recaptchaAvailable: false,
        captcha: null,

        termsAgreed: false,

        from: null,

        promise: {}
      };
    },

    computed: {
    },

    watch: {
      '$route': {
        handler: 'load',
        immediate: true
      }
    },

    // here is the trick : all auth action are on the same component.
    // vue won't reload it, even on route modification.
    // watch on $route will perform any action needed by url state.
    // but this function will be called only once : at the very first load of component
    // so we'll keep the page to go back
    // that's all !
    beforeRouteEnter(to, from, next) {
      next((vm) => {
        vm.from = from;
      });
    },

    mounted() {
      const recaptchaScript = document.createElement('script');
      recaptchaScript.async = true;
      recaptchaScript.setAttribute('src', 'https://www.google.com/recaptcha/api.js?onload=vueRecaptchaApiLoaded&render=explicit');
      document.head.appendChild(recaptchaScript);
    },

    methods: {
      setMode(mode) {
        this.mode = mode;
        this.promise = {};
      },

      load() {
        if (this.$route.hash) { // keep compatible with v6 AngularJs hacks...
          this.$router.replace(this.$route.fullPath.replace('#', '?'));
        }

        if (this.$route.query.change_password) {
          // change password mode
          // mode when user has forgotten his password.
          // an url is sent to his mail, with an secret param
          this.setMode('changePassword');
        } else if (this.$route.query.validate_change_email) {
          // when user changes his email.
          // he receives on his new mail a secret url to validate
          // that  he is the owner
          this.setMode('changeEmail');
          this.promise = c2c.userProfile.validateChangeEmail(this.$route.query.validate_change_email)
            .then(() => this.$router.push({ name: 'home' }));
        } else if (this.$route.query.validate_register_email) {
          // after account creation
          this.setMode('validateAccountCreation');
          this.promise = c2c.userProfile.validateRegisterEmail(this.$route.query.validate_register_email)
            .then(() => this.$router.push({ name: 'home' }));
        } else {
          this.setMode('signin');
        }
      },

      signin() {
        this.promise = this.$user.signIn(this.username, this.password)
          .then(() => this.$router.push(this.from.fullPath));
      },

      signup() {
        this.promise = c2c.userProfile.register({
          name: this.name,
          username: this.username,
          forum_username: this.forum_username,
          password: this.password,
          email: this.email,
          lang: this.$language.current,
          captcha: this.captcha
        });

        this.captcha = null;
        this.$refs.recaptcha.reset();
      },

      resetPassword() {
        this.promise = c2c.userProfile.requestPasswordChange(this.email);
      },

      validateNewPassword() {
        const password = this.password;
        const nonce = this.$route.query.change_password;

        this.promise = c2c.userProfile.validateNewPassword(nonce, password)
          .then(() => this.$router.push({ name: 'auth' }));
      },

      onCaptchaExpired() {
        this.$refs.recaptcha.reset();
      },

      onCaptchaVerify(captchaKey) {
        this.captcha = captchaKey;
      }
    }
  };
</script>

<style lang="scss" scoped>
  @import '@/assets/sass/variables.scss';

  .login-view {
    height:100%;
    align-items:center;
    width:30rem;
    max-width:100vw;
    margin:auto;

    form{
      width: 100%;
      padding: 1.5rem;
    }
  }

</style>
